%toc%

<div className="article-content">

## useActionStateã¯ä½•ã‚’ã™ã‚‹hookï¼Ÿ

`useActionState` ã¯ **ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆActionï¼‰ã‚’ãƒˆãƒªã‚¬ãƒ¼ã«å‡¦ç†ã‚’å®Ÿè¡Œã—ã€ãã®å‡¦ç†çµæœã‚’ state ã«åæ˜ ã™ã‚‹ãƒ•ãƒƒã‚¯** ã§ã™ã€‚

â€»ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆActionï¼‰ã¨ã„ã†ã®ã¯ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯ã€é–¢æ•°å®Ÿè¡Œãªã©ã‚’æŒ‡ã—ã¦ã„ã¦ç‰¹ã«ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡ã®ã“ã¨ãŒå¤šã„ã§ã™

stateãŒã‚ã‚Šã€ãã‚Œã‚’ç®¡ç†ãƒ»æ›´æ–°ã™ã‚‹ã¨ã„ã†ä¸€éƒ¨åˆ†ã§ã¯useStateã‚‚åŒã˜æ©Ÿèƒ½ã‚’æŒã£ã¦ã„ã¾ã™ãŒã€useStateã ã‘ã§ã¯å‡¦ç†ãŒç…©é›‘ã«ãªã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚

ä¾‹ãˆã°ã€ **ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†ã‚’å®Ÿè¡Œã™ã‚‹ã¨ãã€ãƒ­ã‚°ã‚¤ãƒ³ã®æˆåŠŸåˆ¤å®šï¼ˆstateï¼‰ã¨å‡¦ç†ä¸­ï¼ˆisPendingï¼‰ã®çŠ¶æ…‹ã‚’ç®¡ç†ã—ãŸã„ï¼** ã€ã¨ã„ã†å ´é¢ã§`useActionState`ã¯ã¨ã¦ã‚‚ä½¿ã„å‹æ‰‹ãŒè‰¯ã„ã§ã™ã€‚

ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã®æ„å‘³ãŒã‚ã‹ã‚‹ã‚ˆã†ã«æ§‹æ–‡ã®èª¬æ˜ã‹ã‚‰ã€å¿œç”¨çš„ãªä½¿ã„æ–¹ã‚’ç´¹ä»‹ã—ã¦ã„ãã¾ã™ã€‚

```tsx
const [isSuccess, signupAction, isPending] =
  useActionState(signup, null)

return(
  <div>
    {isSuccess && <p>âœ… ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—æˆåŠŸ</p>}

    <form action={signupAction}>
      <button disabled={isPending}>
        {isPending ? 'å‡¦ç†ä¸­...' : 'ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—'}
      </button>
    </form>
  </div>
)
```

## useActionStateã®æ§‹æ–‡

```tsx
// ã‚ˆãã‚ã‚‹å‘½å
const [state, formAction, isPending] =
  useActionState(actionFn, initialState, permalink?)
```

formAction ãŒå†…éƒ¨ã§ actionFn ã‚’å‘¼ã³å‡ºã—ã€è¿”ã‚Šå€¤ã‚’ãã®ã¾ã¾ state ã«åæ˜ ã—ã¦ãã‚Œã¾ã™


### å¼•æ•°

1. **actionFn**
    - `(prevState, formData) => newState` ã®å½¢ã®é–¢æ•°
    - **ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡æ™‚ãªã©ã«å‘¼ã³å‡ºã•ã‚Œã€è¿”ã—ãŸå€¤ãŒæ–°ã—ã„ state ã«ãªã‚‹**
2. **initialState**
    - æœ€åˆã® state ã®å€¤
3. **permalinkï¼ˆçœç•¥å¯ï¼‰**
    - JavaScript ç„¡åŠ¹æ™‚ãªã©ã®å ´é¢ã«å‚™ãˆã¦è¨­å®šã™ã‚‹é–¢æ•°å‡¦ç†å¾Œã®é·ç§»å…ˆURL
    - æ™®æ®µã¯çœç•¥ã™ã‚‹ã®ãŒä¸€èˆ¬çš„
    - é€šå¸¸ã®é·ç§»ã¯åˆ¥ã®æ–¹æ³•ã‚’ä½¿ã†

### è¿”ã‚Šå€¤

1. **state**
    - åˆå›ã¯ `initialState`
    - `actionFn` ã®è¿”ã‚Šå€¤ã§è‡ªå‹•æ›´æ–°ã•ã‚Œã‚‹
2. **formAction**
    - `<form action={formAction}>`ãªã©ã«æ¸¡ã™
3. **isPending**
    - å‡¦ç†ä¸­ãªã‚‰ `true`

### å¼•æ•°ã¨è¿”ã‚Šå€¤ã®å‘½å

useStateã¨åŒã˜ã§ã€å¼•æ•°ã‚‚è¿”ã‚Šå€¤ã‚‚é…åˆ—ãªã®ã§å‘½åã¯è‡ªç”±ã«ã¤ã‘ã‚‰ã‚Œã¾ã™â†“

```tsx
// ï¼ˆä¾‹ãˆã°...ï¼‰
const [state, action, isPending] =
  useActionState(handle, initialState, permalink?)

// ï¼ˆã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—å‡¦ç†ã®æ–‡è„ˆã ã¨...ï¼‰
const [isSuccess, signupAction, isPending] =
  useActionState(signup, null)
```

## useActionStateã®å‡¦ç†ã®æµã‚Œã‚’å›³è§£

ã“ã‚Œã¯useActionStateã‚’ä½¿ã£ã¦ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—å‡¦ç†å‡¦ç†ã®ã‚³ãƒ¼ãƒ‰ã§ã™â†“

```tsx
const [isSuccess, signupAction, isPending] =
  useActionState(signup, null)

return(
  <div>
    {isSuccess && <p>âœ… ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—æˆåŠŸ</p>}

    <form action={signupAction}>
      <button disabled={isPending}>
        {isPending ? 'å‡¦ç†ä¸­...' : 'ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—'}
      </button>
    </form>
  </div>
)
```

ã“ã®ã‚³ãƒ¼ãƒ‰ã‚’å›³è§£ã™ã‚‹ã¨ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã™

- ã‚·ãƒ¼ã‚±ãƒ³ã‚¹å›³â†“

```mermaid
sequenceDiagram
    participant User as ãƒ¦ãƒ¼ã‚¶ãƒ¼
    participant Form as <form action={signupAction}>
    participant signupAction as signupAction (ãƒ©ãƒƒãƒ‘ãƒ¼)
    participant signup as signup (ãƒ­ã‚¸ãƒƒã‚¯æœ¬ä½“)

    User->>Form: ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦é€ä¿¡
    Form->>signupAction: actionå±æ€§ã§å‘¼ã³å‡ºã•ã‚Œã‚‹
    Note over signupAction: isPending = true
    signupAction->>signup: (prevState, formData) ã‚’æ¸¡ã—ã¦å®Ÿè¡Œ
    signup-->>signupAction: success ã‚’è¿”ã™
    Note over signupAction: isPending = false
```

---

- ã‚·ãƒ¼ã‚±ãƒ³ã‚¹å›³ã‚’å¤§é›‘æŠŠãªæµã‚Œã«ã—ãŸã‚‚ã®â†“

```mermaid
flowchart TD
    %% 1. ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œ
    subgraph Step1["1.ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œ"]
        U["ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ•ã‚©ãƒ¼ãƒ ã®é€ä¿¡ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™"]
    end

    %% 2. ãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰ signupAction
    subgraph Step2["2.signupAction"]
        F["formãŒsignupActionã‚’å‘¼ã³å‡ºã™"]
        P["signupActionãŒ<br/>isPendingã‚’trueã«è¨­å®š"]
        C["signupActionãŒ<br/>signupã‚’å‘¼ã³å‡ºã™"]
    end

    %% 3. signupå®Ÿè¡Œ
    subgraph Step3["3.signupã®å‡¦ç†"]
        A["signupãŒå‡¦ç†ã‚’å®Ÿè¡Œã—newStateã‚’è¿”ã™"]
    end

    %% 4. React Stateæ›´æ–°
    subgraph Step4["4.Stateã®æ›´æ–°"]
        S["newStateã§stateã‚’æ›´æ–°"]
        Q["isPendingã‚’falseã«æˆ»ã™"]
    end

    %% çŸ¢å°ã®æµã‚Œ
    U --> F --> P --> C --> A --> S --> Q
```

## `useState` ã¨ã®é•ã„

### useState

stateã‚’ç®¡ç†ã™ã‚‹ãŸã‚ã®ã‚‚ã®

```tsx
const [state, setState] = useState(initialState);

<form onSubmit={(e) => {
  e.preventDefault();
  setState(state + 1);
}}>
  <button>+</button>
</form>
```

* **è¿”ã‚Šå€¤:** `[state, setState]`
* æ›´æ–°æ–¹æ³•: `setState(newValue)` ã‚’è‡ªåˆ†ã§å‘¼ã¶
* å‡¦ç†å†…å®¹ã¯å‘¼ã³å‡ºã—æ™‚ã«è¨­å®š

### useActionState

actionFnï¼ˆå‡¦ç†ï¼‰ã®çµæœãƒ»å‡¦ç†çŠ¶æ…‹ã‚’ç®¡ç†ã™ã‚‹ãŸã‚ã®ã‚‚ã®

```tsx
const [state, formAction, isPending] =
  useActionState(async (prevState, formData) => {
    return prevState + 1;
  }, 0);

<form action={formAction}>
  {state}
  <button disabled={isPending}>+</button>
</form>
```

* **è¿”ã‚Šå€¤:** `[state, formAction, isPending]`
* æ›´æ–°æ–¹æ³•: `formAction` ã‚’ãƒ•ã‚©ãƒ¼ãƒ ã«æ¸¡ã™ã ã‘ã§OKï¼ˆå†…éƒ¨ã§è‡ªå‹•æ›´æ–°ï¼‰
* å‡¦ç†å†…å®¹ã¯æœ€åˆã«å®šç¾©

### è¿”ã‚Šå€¤ã®é•ã„ã¾ã¨ã‚

| ãƒ•ãƒƒã‚¯             | æˆ»ã‚Šå€¤                           | æ›´æ–°æ–¹æ³•                          |
| ------------------ | -------------------------------- | --------------------------------- |
| **useState**       | `[state, setState]`              | `setState(newValue)` ã‚’æ‰‹å‹•ã§å‘¼ã¶ |
| **useActionState** | `[state, formAction, isPending]` | `formAction` ã‚’ãƒ•ã‚©ãƒ¼ãƒ ã«æ¸¡ã™ã ã‘ |

```mermaid
graph LR
    %% useState
    A["useState"] --> B["state"]
    A --> C["setState ï¼ˆæ‰‹å‹•ã§å‘¼ã¶ï¼‰"]

    %% useActionState
    D["useActionState"] --> E["state"]
    D --> F["formAction ï¼ˆãƒ•ã‚©ãƒ¼ãƒ ã«æ¸¡ã™ï¼‰"]
    D --> G["isPending ï¼ˆå‡¦ç†ä¸­ãƒ•ãƒ©ã‚°ï¼‰"]
    F --> H["actionFn ï¼ˆå‡¦ç†æœ¬ä½“ï¼‰"]

    %% åŒã˜æ„å‘³ã®ã‚‚ã®ã¯åŒã˜è‰²
    %% 1. state (B ã¨ E)
    style B stroke:#52c41a,stroke-width:2px
    style E stroke:#52c41a,stroke-width:2px

    %% 2. æ›´æ–°ã®ä»•çµ„ã¿ (C ã¨ F+H)
    style C stroke:#1890ff,stroke-width:2px
    style F stroke:#1890ff,stroke-width:2px
    style H stroke:#1890ff,stroke-width:2px

    %% 3. è£œåŠ©æ©Ÿèƒ½ isPending (G)
    style G stroke:#fa8c16,stroke-width:2px
```

## useStateã‚ˆã‚Šã‚‚useActionStateã‚’ä½¿ã†ã¹ãä¾‹

ä»¥ä¸‹ã®ã‚ˆã†ãªå ´é¢ã§ã¯ `useActionState` ã®æ–¹ãŒé©ã—ã¦ã„ã¾ã™ï¼š

1. **ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡å‡¦ç†**
    - ãƒ•ã‚©ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã®é€ä¿¡
    - ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³çµæœã®è¡¨ç¤º
    - é€ä¿¡æˆåŠŸ/å¤±æ•—ã®çŠ¶æ…‹ç®¡ç†

2. **éåŒæœŸå‡¦ç†ã®çŠ¶æ…‹ç®¡ç†**
    - APIå‘¼ã³å‡ºã—
    - ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ“ä½œ
    - ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰

3. **ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ã®è¡¨ç¤º**
    - å‡¦ç†ä¸­ã®UIè¡¨ç¤º
    - ãƒœã‚¿ãƒ³ã®ç„¡åŠ¹åŒ–
    - ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã®è¡¨ç¤º

### ãƒ­ã‚°ã‚¤ãƒ³ãƒ•ã‚©ãƒ¼ãƒ ã®ä¾‹

ä»®ã«ä»¥ä¸‹ã®è¦ä»¶ã§ãƒ­ã‚°ã‚¤ãƒ³ãƒ•ã‚©ãƒ¼ãƒ ã‚’å®Ÿè£…ã™ã‚‹ä¾‹ã‚’è¦‹ã¦ã¿ã¾ã—ã‚‡ã†
- ãƒ­ã‚°ã‚¤ãƒ³ã®æˆåŠŸå¯å¦ã§ãƒˆãƒ¼ã‚¹ãƒˆã‚’å‡ºã™
- ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†ä¸­ã¯ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’å‡ºã™

#### useStateã§å®Ÿè£…
```tsx
// ğŸ§ useStateãŒ2ã¤å¿…è¦
const [isLoading, setIsLoading] = useState(false)
const [result, setResult] = useState(null)

// çµæœã«å¿œã˜ã¦ãƒˆãƒ¼ã‚¹ãƒˆè¡¨ç¤º
useEffect(() => {
  if (result === 'success') {
    toast.success('âœ… ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸï¼')
    setResult(null) // ãƒªã‚»ãƒƒãƒˆ
  }
}, [result])

useEffect(() => {
  if (result === 'error') {
    toast.error('âŒ ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—')
    setResult(null) // ãƒªã‚»ãƒƒãƒˆ
  }
}, [result])

// ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†
const handleSubmit = async (e) => {
  e.preventDefault()
  setIsLoading(true)
  setResult(null)

  try {
    const formData = new FormData(e.target)
    const response = await loginUser(formData)
    setResult('success')
  } catch (err) {
    setResult('error')
  } finally {
    setIsLoading(false)
  }
}

return (
  <form onSubmit={handleSubmit}>
    <button disabled={isLoading}>
      {isLoading ? 'ãƒ­ã‚°ã‚¤ãƒ³ä¸­...' : 'ãƒ­ã‚°ã‚¤ãƒ³'}
    </button>
  </form>
)
```

#### useActionState ã§å®Ÿè£…

```tsx
// ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†
const login = async (prevState, formData) => {
  try {
    const result = await loginUser(formData)
    return { status: 'success' }
  } catch (err) {
    return { status: 'error' }
  }
}

// useActionState 1ã¤ã§çŠ¶æ…‹ã‚’ç®¡ç†ã§ãã€
// ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†ã¨ã®é–¢ä¿‚ã‚‚ã‚ã‹ã‚Šã‚„ã™ã„
const [state, loginAction, isPending] = useActionState(
  login, { status: null }
)

// æˆåŠŸæ™‚ã®ãƒˆãƒ¼ã‚¹ãƒˆè¡¨ç¤º
useEffect(() => {
  if (state.status === 'success') {
    toast.success('âœ… ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸï¼')
  }
}, [state.status])

// ã‚¨ãƒ©ãƒ¼æ™‚ã®ãƒˆãƒ¼ã‚¹ãƒˆè¡¨ç¤º
useEffect(() => {
  if (state.status === 'error') {
    toast.error(`âŒ ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—`)
  }
}, [state.status])

return (
  <form action={loginAction}>
    <button disabled={isPending}>
      {isPending ? 'ãƒ­ã‚°ã‚¤ãƒ³ä¸­...' : 'ãƒ­ã‚°ã‚¤ãƒ³'}
    </button>
  </form>
)
```

## useActionStateã§useEffectã‚’ãªã‚‹ã¹ãä½¿ã‚ãªã„æ–¹æ³•

useStateã‚ˆã‚Šã‚‚useActionStateãŒä¾¿åˆ©ã«æ›¸ã‘ã¾ã—ãŸãŒã€å…ˆã»ã©ã®ãƒˆãƒ¼ã‚¹ãƒˆã‚’è¡¨ç¤ºã™ã‚‹ã¨ãã«`useEffect`ã‚’ä½¿ã£ã¦ã—ã¾ã£ã¦ã„ã¾ã™ã€‚

useEffectã‚’ä½¿ã‚ãªã„æ–¹æ³•ã‚’2ã¤ç´¹ä»‹ã—ã¾ã™

### useActionStateã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã§ã®ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

useActionStateã®actionFnã«ã¾ã¨ã‚ã¦æ›¸ã„ã¦ã—ã¾ã†ã‚„ã‚Šæ–¹ã§ã™ã€‚  
ãŸã ã€å°‘ã—è¤‡é›‘ã§ã™ã€‚

```tsx
const [state, loginAction, isPending] = useActionState(
  async (prev, formData) => {
    const { status } = await login(prev, formData)

    if (status === 'success') {
      toast.success('âœ… ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸï¼')
    }

    if (status === 'error') {
      toast.error(`âŒ ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—`)
    }
  },
  null
)
```

### withCallbacksã‚’ä½¿ç”¨

æ¬¡ã«`withCallbacks`ã¨ã„ã†é–¢æ•°ã‚’è‡ªå‰ã§ç”¨æ„ã—ã¦ãŠãã€ãã‚Œã‚’ä½¿ç”¨ã™ã‚‹æ–¹æ³•ã§ã™ã€‚

```tsx
const [state, loginAction, isPending] = useActionState(
  withCallbacks(login, {
    onSuccess() {
      toast.success('âœ… ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸï¼')
    },
    onError() {
       toast.error(`âŒ ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—`)
    },
  }),
  { success: false }
)
```

withCallbacksé–¢æ•°â†“  
è¤‡é›‘ã§ã™ãŒã€ä¸€åº¦å®šç¾©ã—ã¦ã—ã¾ãˆã°å¾Œã¯æ¥½ã§ã™ã€‚

```tsx
type Callbacks<T, R = unknown> = {
  onStart?: () => R
  onEnd?: (reference: R) => void
  onSuccess?: (result: T) => void
  onError?: (result: T) => void
}

export const withCallbacks = <
  Args extends unknown[],
  T,
  R = unknown,
>(
  fn: (...args: Args) => Promise<T>,
  callbacks: Callbacks<T, R>,
) => {
  return async (...args: Args) => {
    const promise = fn(...args)

    const reference = callbacks.onStart?.()
    const result = await promise

    if (reference) {
      callbacks.onEnd?.(reference)
    }

    if (result.status === 'success') {
      callbacks.onSuccess?.(result)
    }

    if (result.status === 'error') {
      callbacks.onError?.(result)
    }

    return promise
  }
}
```

</div>
